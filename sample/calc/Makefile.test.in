# -*- Makefile -*-

prefix = @prefix@

TESTSRC += $(wildcard test/test_*.c)
TESTOBJS = $(patsubst test/test_%.c,test/test_%.o,$(TESTSRC))
TESTSOBJS = $(patsubst test/test_%.c,test/libtest_%.so,$(TESTSRC))

SRC += $(wildcard $(patsubst test/test_%.c,src/%.c,$(TESTSRC)))
OBJS = $(patsubst %.c,%.o,$(SRC))
SRC += $(wildcard $(patsubst test/test_%.c,src/%.h,$(TESTSRC)))

CC = @CC@

CFLAGS += -Wall
CFLAGS += -ggdb -Isrc -Itest -I@includedir@
LDFLAGS += -L./
LIBS += -ldl -lm

MKDEP=$(CC) $(CFLAGS) $(DEFS) $(INCLUDES) -MM -MG

CUTTER=cutter
CUTTER_FLAGS=-vp

### command printing start
cmd_cc = $(CC) $(CFLAGS) -o $@ -c $<

cmd_shared = $(CC) $(LDFLAGS) -shared -o $@ $<

cmd_link = $(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
### command printing

### depend start
ifeq (.depend,$(wildcard .depend))
include .depend
endif
### depend

all: .depend
	@$(MAKE) main

test: .depend
	@$(MAKE) do-test

do-test: $(TESTOBJS) $(TESTSOBJS)
	$(CUTTER) $(CUTTER_FLAGS)

test/libtest_%.so: test/test_%.o $(OBJS)
	$(cmd_shared) \
		$(patsubst src/%.c,src/%.o, \
			$(wildcard \
				$(patsubst test/test_%.o,src/%.c,$<)))

clean:
	rm -f *~
	rm -f .depend
	rm -f test/*.so
	rm -f test/*.o
	rm -f src/*.o

.depend: $(SRC) $(TESTSRC)
	$(MKDEP) $(SRC) | sed -e 's,^\(.*\):,src/\1:,' > .depend.src
	$(MKDEP) $(TESTSRC) | sed -e 's,^\(.*\):,test/\1:,' > .depend.test
	cat .depend.src .depend.test > .depend
	rm .depend.src .depend.test

.PHONY: test do-test \
	depend-start depend-start-test \
	depend depend-required
